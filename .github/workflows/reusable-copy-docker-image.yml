name: Reusable Docker build and push workflow

on:
  workflow_call:
   inputs:

      image_name:
          required: true
          type: string

      source_environment:
        required: true
        type: string

      destination_environment:
        required: true
        type: string

jobs:
  get-source-acr-details:
    runs-on: ubuntu-latest
    environment: ${{ inputs.source_environment }}
    outputs:
      source-acr: ${{ steps.get-source-acr-credentials.outputs.source-acr }}
      source-acr-user-name: ${{ steps.get-source-acr-credentials.outputs.source-acr-un }}
      source-acr-password: ${{ steps.get-source-acr-credentials.outputs.source-acr-password }}
    steps:

      - name: Get Source ACR credentials
        id: get-source-acr-credentials
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |

            az_source_acr=${{  secrets.AZURE_CONTAINER_REGISTRY }}
            echo "::add-mask::$az_source_acr"
            echo "::set-output name=source-acr:$az_source_acr"

            az_source_acr_un=${{ secrets.AZURE_CONTAINER_REGISTRY_USER_NAME }}
            echo "::add-mask::$az_source_acr_un"
            echo "::set-output name=source-acr-un:$az_source_acr_un"

            az_source_acr_pwd=${{ secrets.AZURE_CONTAINER_REGISTRY_PASSWORD }}
            echo "::add-mask::$az_source_acr_pwd"
            echo "::set-output name=source-acr-password:$az_source_acr_pwd"

  get-dest-acr-details:
      runs-on: ubuntu-latest
      environment: ${{ inputs.destination_environment }}
      outputs:
        dest-acr: ${{ steps.get-dest-acr-credentials.outputs.dest-acr }}
        dest-acr-user-name: ${{ steps.get-dest-acr-credentials.outputs.dest-acr-un }}
        dest-acr-password: ${{ steps.get-dest-acr-credentials.outputs.dest-acr-password }}
      steps:
        - name: Get Destination ACR credentials
          id: get-dest-acr-credentials
          uses: azure/cli@v2
          with:
            azcliversion: latest
            inlineScript: |
              az_dest_acr=${{ secrets.AZURE_CONTAINER_REGISTRY }}
              echo "::add-mask::$az_dest_acr"
              echo "::set-output name=dest-acr:$az_dest_acr"

              az_dest_acr_un=${{ secrets.AZURE_CONTAINER_REGISTRY_USER_NAME }}
              echo "::add-mask::$az_dest_acr_un"
              echo "::set-output name=dest-acr-un:$az_dest_acr_un"

              az_dest_acr_pwd=${{ secrets.AZURE_CONTAINER_REGISTRY_PASSWORD }}
              echo "::add-mask::$az_dest_acr_pwd"
              echo "::set-output name=dest-acr-password:$az_dest_acr_pwd"

  docker-copy-image:
    runs-on: ubuntu-latest
    needs: [get-source-acr-details, get-dest-acr-details]

    steps:

      - name: Login to Source ACR
        run: |
         echo ${{ needs.get-source-acr-details.outputs.source-acr-password }} | docker login ${{ needs.get-source-acr-details.outputs.source-acr }} -u ${{ needs.get-source-acr-details.outputs.source-acr-user-name }} --password-stdin

      - name: Pull Docker image from Source ACR
        run: |
           docker pull ${{ needs.get-source-acr-details.outputs.source-acr }}/${{ inputs.image_name }}:latest

      - name: Tag Docker image for Destination ACR
        run: |
          docker tag ${{ needs.get-source-acr-details.outputs.source-acr }}/${{ inputs.image_name }}:latest ${{ needs.get-dest-acr-details.outputs.dest-acr }}/${{ inputs.image_name }}:latest

      - name: Login to Destination ACR
        run: |
          echo ${{ needs.get-dest-acr-details.outputs.dest-acr-password }} | docker login ${{ needs.get-dest-acr-details.outputs.dest-acr }} -u ${{ needs.get-dest-acr-details.outputs.dest-acr-user-name }} --password-stdin


      - name: Push Docker image to Destination ACR
        run: |
          docker push ${{ needs.get-dest-acr-details.outputs.dest-acr }}/${{ inputs.image_name }}:latest
